{
  if (x.rank() == 3) {
    int leadDim=x.size(0);
    int cDim=x.size(1);
    int rdim=(int)Math.round(((double)x.length() / ((double)leadDim * (double)cDim)));
    if (rdim < 1)     rdim=1;
    if (leadDim * cDim * rdim != x.length())     throw new IllegalArgumentException("Illegal input for batch size");
    return new int[]{leadDim,cDim,rdim};
  }
 else   if (x.rank() == 4) {
    int leadDim=x.size(0);
    int cDim=x.size(1);
    int wDim=x.size(2);
    int rdim=x.size(3);
    if (rdim < 1)     rdim=1;
    if (cDim * wDim * rdim == x.length())     throw new IllegalArgumentException("Illegal input for batch size");
    return new int[]{1,cDim,wDim,rdim};
  }
 else   throw new IllegalStateException("Unable to process input of rank " + x.rank());
}
