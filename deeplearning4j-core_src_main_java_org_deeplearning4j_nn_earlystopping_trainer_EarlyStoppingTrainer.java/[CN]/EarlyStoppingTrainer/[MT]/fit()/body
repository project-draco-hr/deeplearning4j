{
  log.info("Starting early stopping training");
  if (esConfig.getIterationTerminationConditions() != null) {
    for (    IterationTerminationCondition c : esConfig.getIterationTerminationConditions()) {
      c.initialize();
    }
  }
  if (esConfig.getEpochTerminationConditions() != null) {
    for (    EpochTerminationCondition c : esConfig.getEpochTerminationConditions()) {
      c.initialize();
    }
  }
  Map<Integer,Double> scoreVsEpoch=new LinkedHashMap<>();
  int epochCount=0;
  while (true) {
    train.reset();
    double lastScore;
    boolean terminate=false;
    IterationTerminationCondition terminationReason=null;
    int iterCount=0;
    while (train.hasNext()) {
      DataSet ds=train.next();
      try {
        net.fit(ds);
      }
 catch (      Exception e) {
        log.warn("Early stopping training terminated due to exception at epoch {}, iteration {}",epochCount,iterCount,e);
        return new EarlyStoppingResult(EarlyStoppingResult.TerminationReason.Error,e.toString(),scoreVsEpoch,bestModelEpoch,bestModelScore,epochCount,net);
      }
      lastScore=net.score();
      for (      IterationTerminationCondition c : esConfig.getIterationTerminationConditions()) {
        if (c.terminate(lastScore)) {
          terminate=true;
          terminationReason=c;
          break;
        }
      }
      if (terminate)       break;
      iterCount++;
    }
    if (terminate) {
      log.info("Hit per iteration epoch condition at epoch {}, iteration {}. Reason: {}",epochCount,iterCount,terminationReason);
      return new EarlyStoppingResult(EarlyStoppingResult.TerminationReason.IterationTerminationCondition,terminationReason.toString(),scoreVsEpoch,bestModelEpoch,bestModelScore,epochCount,net);
    }
    log.info("Completed training epoch {}",epochCount);
    epochCount++;
    if ((epochCount == 0 && esConfig.getEvaluateEveryNEpochs() == 1) || epochCount % esConfig.getEvaluateEveryNEpochs() == 0) {
      double score=esConfig.getScoreCalculator().calculateScore(net);
      scoreVsEpoch.put(epochCount - 1,score);
      if (score < bestModelScore) {
        if (bestModelEpoch == -1) {
          log.info("Score at epoch {}: {}",epochCount,score);
        }
 else {
          log.info("New best model: score = {}, epoch = {} (previous: score = {}, epoch = {})",score,epochCount,bestModelScore,bestModelEpoch);
        }
        bestModelScore=score;
        bestModelEpoch=epochCount;
        try {
          esConfig.getModelSaver().saveBestModel(net,score);
        }
 catch (        IOException e) {
          throw new RuntimeException("Error saving best model",e);
        }
      }
      if (esConfig.isSaveLastModel()) {
        try {
          esConfig.getModelSaver().saveLatestModel(net,score);
        }
 catch (        IOException e) {
          throw new RuntimeException("Error saving most frequent model",e);
        }
      }
      boolean epochTerminate=false;
      EpochTerminationCondition termReason=null;
      for (      EpochTerminationCondition c : esConfig.getEpochTerminationConditions()) {
        if (c.terminate(epochCount)) {
          epochTerminate=true;
          termReason=c;
          break;
        }
      }
      if (epochTerminate) {
        return new EarlyStoppingResult(EarlyStoppingResult.TerminationReason.EpochTerminationCondition,termReason.toString(),scoreVsEpoch,bestModelEpoch,bestModelScore,epochCount,net);
      }
      epochCount++;
    }
  }
}
