{
  List<Pair<DoubleMatrix,DoubleMatrix>> deltas=new ArrayList<>();
  computeDeltas(deltas);
  for (int l=0; l < nLayers; l++) {
    DoubleMatrix add=deltas.get(l).getFirst().div(input.rows);
    if (isUseAdaGrad())     add.muli(this.getLayers()[l].getAdaGrad().getLearningRates(add));
 else     add.muli(lr);
    add.divi(input.rows);
    if (useRegularization) {
      add.muli(this.getLayers()[l].getW().mul(l2));
    }
    this.getLayers()[l].getW().addi(add);
    this.getSigmoidLayers()[l].setW(layers[l].getW());
    DoubleMatrix deltaColumnSums=deltas.get(l + 1).getSecond().columnSums();
    deltaColumnSums.divi(input.rows);
    getLayers()[l].gethBias().addi(deltaColumnSums.mul(lr));
    getSigmoidLayers()[l].setB(getLayers()[l].gethBias());
  }
  getLogLayer().getW().addi(deltas.get(nLayers).getFirst());
}
