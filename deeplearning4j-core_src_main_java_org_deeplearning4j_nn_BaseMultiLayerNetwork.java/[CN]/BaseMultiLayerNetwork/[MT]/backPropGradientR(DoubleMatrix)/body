{
  List<DoubleMatrix> deltas=new ArrayList<>();
  computeDeltasR(deltas,v);
  List<Pair<DoubleMatrix,DoubleMatrix>> list=new ArrayList<>();
  for (int l=0; l < getnLayers(); l++) {
    DoubleMatrix gradientChange=deltas.get(l);
    if (isNaN(gradientChange))     throw new IllegalStateException("Gradient change was NaN");
    if (gradientChange.length != getLayers()[l].getW().length)     throw new IllegalStateException("Gradient change not equal to weight change");
    DoubleMatrix deltaColumnSums=deltas.get(l).columnSums();
    if (deltaColumnSums.length != layers[l].gethBias().length)     throw new IllegalStateException("Bias change not equal to weight change");
    list.add(new Pair<>(gradientChange,deltaColumnSums));
  }
  DoubleMatrix logLayerGradient=deltas.get(getnLayers());
  DoubleMatrix biasGradient=deltas.get(getnLayers()).columnSums();
  list.add(new Pair<>(logLayerGradient,biasGradient));
  DoubleMatrix pack=pack(list);
  if (l2 > 0)   pack.addi(mask.mul(v).mul(l2));
 else   pack.addi(mask.mul(v));
  pack.addi(v.mul(dampingFactor));
  return unPack(pack);
}
