{
  DoubleMatrix[] gradients=new DoubleMatrix[getnLayers() + 2];
  DoubleMatrix[] deltas=new DoubleMatrix[getnLayers() + 2];
  ActivationFunction derivative=getSigmoidLayers()[0].getActivationFunction();
  ActivationFunction softMaxDerivative=outputLayer.getActivationFunction();
  DoubleMatrix delta=null;
  List<DoubleMatrix> activations=feedForward();
  List<DoubleMatrix> weights=new ArrayList<>();
  for (int j=0; j < getLayers().length; j++)   weights.add(getLayers()[j].getW());
  weights.add(getOutputLayer().getW());
  for (int i=getnLayers() + 1; i >= 0; i--) {
    if (i >= getnLayers() + 1) {
      delta=labels.sub(activations.get(i)).neg().mul(softMaxDerivative.applyDerivative(activations.get(i)));
      deltas[i]=delta;
    }
 else {
      deltas[i]=deltas[i + 1].mmul(weights.get(i).transpose()).muli(derivative.applyDerivative(activations.get(i)));
      DoubleMatrix newGradient=deltas[i + 1].transpose().mmul(activations.get(i));
      gradients[i]=newGradient;
    }
  }
  for (int i=0; i < gradients.length; i++)   deltaRet.add(new Pair<>(gradients[i],deltas[i]));
}
