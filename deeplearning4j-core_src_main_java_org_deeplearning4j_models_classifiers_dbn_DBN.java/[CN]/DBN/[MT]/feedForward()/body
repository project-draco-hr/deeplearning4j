{
  INDArray currInput=this.input;
  if (this.input.columns() != defaultConfiguration.getnIn())   throw new IllegalStateException("Illegal input length");
  List<INDArray> activations=new ArrayList<>();
  activations.add(currInput);
  for (int i=0; i < getnLayers(); i++) {
    NeuralNetwork layer=getNeuralNets()[i];
    Layer l=(Layer)getLayers()[i];
    boolean activateOnly=layerWiseConfigurations.get(i).isUseHiddenActivationsForwardProp();
    layer.setInput(currInput);
    l.setInput(currInput);
    if (useRBMPropUpAsActivations) {
      RBM r=(RBM)layer;
      if (sampleFromHiddenActivations)       currInput=layer.sampleHiddenGivenVisible(currInput).getSecond();
 else       currInput=r.propUp(currInput);
    }
 else     if (activateOnly)     currInput=l.activate(layer.transform(currInput));
 else     if (sampleFromHiddenActivations)     currInput=layer.sampleHiddenGivenVisible(l.conf().getActivationFunction().apply(currInput)).getSecond();
 else     currInput=layer.sampleHiddenGivenVisible(currInput).getSecond();
    activations.add(currInput);
  }
  if (getOutputLayer() != null) {
    getOutputLayer().setInput(activations.get(activations.size() - 1));
    activations.add(getOutputLayer().output(activations.get(activations.size() - 1)));
  }
  return activations;
}
