{
  INDArray outcomeSequence=labels.isColumnVector() || labels.isRowVector() || binaryLabelMatrix ? toOutcomesFromBinaryLabelMatrix(labels) : labels;
  int frames=outcomeSequence.length();
  INDArray V=NDArrays.ones(frames,states);
  INDArray pointers=NDArrays.zeros(frames,states);
  INDArray assigned=V.getRow(0);
  assigned.assign(logPCorrect - logStates);
  V.putRow(0,assigned);
  V.put(0,(int)outcomeSequence.getScalar(0).element(),NDArrays.scalar(logPCorrect - logStates));
  for (int t=1; t < frames; t++) {
    for (int k=0; k < states; k++) {
      INDArray rowLogProduct=rowOfLogTransitionMatrix(k).add(V.getRow(t - 1));
      int maxVal=NDArrays.getBlasWrapper().iamax(rowLogProduct);
      double argMax=(double)rowLogProduct.max(Integer.MAX_VALUE).element();
      V.put(t,k,argMax);
      int element=(int)outcomeSequence.getScalar(t).element();
      if (k == element)       V.put(t,k,logPCorrect + maxVal);
 else       V.put(t,k,logPIncorrect + maxVal);
    }
  }
  INDArray rectified=NDArrays.zeros(frames);
  rectified.put(rectified.length() - 1,V.getRow(frames - 1).max(Integer.MAX_VALUE));
  for (int t=rectified.length() - 2; t > 0; t--) {
    rectified.put(t,pointers.getScalar(t + 1,(int)rectified.getScalar(t + 1).element()));
  }
  return new Pair<>((Double)V.getRow(frames - 1).max(Integer.MAX_VALUE).element(),rectified);
}
