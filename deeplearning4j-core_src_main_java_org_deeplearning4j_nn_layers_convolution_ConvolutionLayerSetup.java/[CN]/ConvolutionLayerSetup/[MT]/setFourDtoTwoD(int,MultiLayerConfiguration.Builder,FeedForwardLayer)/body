{
  Layer currFourdLayer=conf instanceof NeuralNetConfiguration.ListBuilder ? ((NeuralNetConfiguration.ListBuilder)conf).getLayerwise().get(i).getLayer() : conf.getConfs().get(i).getLayer();
  if (currFourdLayer instanceof ConvolutionLayer || currFourdLayer instanceof SubsamplingLayer) {
    if (currFourdLayer instanceof ConvolutionLayer) {
      ConvolutionLayer convolutionLayer=(ConvolutionLayer)currFourdLayer;
      int inputHeight=lastHeight;
      int inputWidth=lastWidth;
      if (convolutionLayer.getKernelSize() != null) {
        d.setNOut(inputHeight * inputWidth * convolutionLayer.getNOut());
      }
 else       throw new IllegalStateException("Unable to infer width and height without convolution layer kernel size");
      conf.inputPreProcessor(i + 1,new CnnToFeedForwardPreProcessor(inputHeight,inputWidth,lastOutChannels));
    }
 else     if (currFourdLayer instanceof SubsamplingLayer) {
      int inputHeight=lastHeight;
      int inputWidth=lastWidth;
      if (i < numLayers - 2) {
        d.setNOut(inputHeight * inputWidth * lastOutChannels);
      }
      conf.inputPreProcessor(i + 1,new CnnToFeedForwardPreProcessor(inputHeight,inputWidth,lastOutChannels));
    }
  }
}
