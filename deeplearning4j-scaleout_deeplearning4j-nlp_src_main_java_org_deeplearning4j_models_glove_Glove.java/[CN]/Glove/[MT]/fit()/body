{
  if (vocabCache == null)   vocabCache=new InMemoryLookupCache();
  if (textVectorizer == null) {
    textVectorizer=new TfidfVectorizer.Builder().tokenize(tokenizerFactory).cache(vocabCache).iterate(sentenceIterator).minWords(minWordFrequency).stopWords(stopWords).stem(stem).build();
    textVectorizer.fit();
  }
  sentenceIterator.reset();
  if (coOccurrences == null) {
    coOccurrences=new CoOccurrences.Builder().cache(vocabCache).iterate(sentenceIterator).tokenizer(tokenizerFactory).windowSize(windowSize).build();
    coOccurrences.fit();
  }
  if (weightLookupTable == null)   weightLookupTable=new GloveWeightLookupTable.Builder().xMax(xMax).cache(vocabCache).lr(learningRate).vectorLength(layerSize).build();
  if (weightLookupTable.getSyn0() == null)   weightLookupTable.resetWeights();
  final List<List<VocabWord>> miniBatches=new CopyOnWriteArrayList<>();
  for (  String s : coOccurrences.getCoOCurreneCounts().keySet()) {
    for (    String s1 : coOccurrences.getCoOCurreneCounts().getCounter(s).keySet()) {
      VocabWord vocabWord=vocabCache.wordFor(s);
      VocabWord vocabWord1=vocabCache.wordFor(s1);
      miniBatches.add(Arrays.asList(vocabWord,vocabWord1));
      if (miniBatches.size() >= batchSize) {
        jobQueue.add(new ArrayList<>(miniBatches));
        miniBatches.clear();
      }
    }
  }
  if (!miniBatches.isEmpty())   jobQueue.add(miniBatches);
  final AtomicInteger processed=new AtomicInteger(coOccurrences.getCoOCurreneCounts().size());
  try {
    Thread.sleep(10000);
  }
 catch (  InterruptedException e) {
    e.printStackTrace();
  }
  Parallelization.runInParallel(Runtime.getRuntime().availableProcessors(),new Runnable(){
    @Override public void run(){
      while (processed.get() > 0) {
        List<List<VocabWord>> batch=jobQueue.poll();
        if (batch == null)         continue;
        for (        List<VocabWord> list : batch) {
          VocabWord w1=list.get(0);
          VocabWord w2=list.get(1);
          double weight=coOccurrences.getCoOCurreneCounts().getCount(w1.getWord(),w2.getWord());
          weightLookupTable.iterateSample(w1,w2,learningRate,weight);
          processed.decrementAndGet();
        }
      }
    }
  }
);
}
