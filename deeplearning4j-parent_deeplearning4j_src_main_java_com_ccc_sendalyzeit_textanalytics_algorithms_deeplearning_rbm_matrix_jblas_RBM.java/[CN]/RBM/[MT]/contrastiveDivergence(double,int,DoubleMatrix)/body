{
  if (input != null)   this.input=input;
  Pair<DoubleMatrix,DoubleMatrix> probHidden=this.sampleHiddenGivenVisible(this.input);
  DoubleMatrix chainStart=probHidden.getSecond();
  Pair<Pair<DoubleMatrix,DoubleMatrix>,Pair<DoubleMatrix,DoubleMatrix>> matrices=null;
  DoubleMatrix nvMeans=null;
  DoubleMatrix nvSamples=null;
  DoubleMatrix nhMeans=null;
  DoubleMatrix nhSamples=null;
  for (int i=0; i < k; i++) {
    if (i == 0)     matrices=gibbhVh(chainStart);
 else     matrices=gibbhVh(nhSamples);
    nvMeans=matrices.getFirst().getFirst();
    nvSamples=matrices.getFirst().getSecond();
    nhMeans=matrices.getSecond().getFirst();
    nhSamples=matrices.getSecond().getSecond();
  }
  DoubleMatrix inputTimesPhSample=this.input.transpose().mmul(probHidden.getSecond());
  DoubleMatrix nvSamplesTTimesNhMeans=nvSamples.transpose().mmul(nhMeans);
  DoubleMatrix diff=inputTimesPhSample.sub(nvSamplesTTimesNhMeans);
  DoubleMatrix wAdd=diff.mul(learningRate);
  W=W.add(wAdd);
  DoubleMatrix vBiasAdd=MatrixUtil.mean(this.input.sub(nvSamples),0).mul(learningRate);
  vBias=vBiasAdd.mul(learningRate);
  DoubleMatrix hBiasAdd=MatrixUtil.mean(probHidden.getSecond().sub(nhMeans),0).mul(learningRate);
  hBiasAdd=hBiasAdd.mul(learningRate);
  hBias=hBias.add(hBiasAdd);
}
