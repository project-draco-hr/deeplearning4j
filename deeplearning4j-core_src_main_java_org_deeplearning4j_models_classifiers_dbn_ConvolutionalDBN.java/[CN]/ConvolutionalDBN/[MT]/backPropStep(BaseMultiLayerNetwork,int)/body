{
  List<INDArray> deltas=new ArrayList<>();
  computeDeltas(deltas);
  for (int l=1; l < getnLayers(); l++) {
    ConvolutionalRBM r=(ConvolutionalRBM)getNeuralNets()[l];
    ConvolutionalRBM prevR=(ConvolutionalRBM)getNeuralNets()[l - 1];
    NeuralNetConfiguration conf=r.conf();
    INDArray wGradient=deltas.get(l);
    INDArray biasGradient=deltas.get(l).mean(1);
    INDArray biasLearningRates=null;
    AdaGrad wAdaGrad=r.getAdaGrad();
    if (conf.isUseAdaGrad())     biasLearningRates=neuralNets[l].gethBiasAdaGrad().getLearningRates(biasGradient);
    for (int m=0; m < r.getNumFilters()[0]; m++) {
      if (conf.isUseAdaGrad())       biasGradient.put(m,biasLearningRates.getScalar(m).muli(r.gethBias().getScalar(m)));
 else       biasGradient.put(m,r.gethBias().getScalar(m).muli(conf.getLr()));
      for (int n=0; n < prevR.getNumFilters()[0]; n++) {
        if (conf.isUseRegularization()) {
          INDArray penalty=r.getFeatureMap().slice(m,n).mul(conf.getL2());
          if (conf.isUseAdaGrad()) {
            INDArray learningRates=wAdaGrad.getLearningRates(wGradient.slice(m).slice(n));
            penalty.muli(learningRates);
          }
 else           penalty.muli(conf.getLr());
          wGradient.put(m,n,wGradient.slice(m).slice(n).mul(penalty));
        }
      }
    }
    INDArray gradientChange=deltas.get(l);
    if (conf.isUseAdaGrad())     gradientChange.muli(getNeuralNets()[l].getAdaGrad().getLearningRates(gradientChange));
 else     gradientChange.muli(conf.getLr());
    if (conf.isUseRegularization())     gradientChange.muli(getNeuralNets()[l].getW().mul(conf.getL2()));
    if (conf.getMomentum() != 0)     gradientChange.muli(conf.getMomentum());
    gradientChange.divi(input.rows());
    getNeuralNets()[l].getW().subi(gradientChange);
    getNeuralNets()[l].setW(neuralNets[l].getW());
    INDArray deltaColumnSums=deltas.get(l).mean(1);
    if (conf.getSparsity() != 0)     deltaColumnSums=deltaColumnSums.rsubi(conf.getSparsity());
    if (conf.isUseAdaGrad())     deltaColumnSums.muli(neuralNets[l].gethBiasAdaGrad().getLearningRates(deltaColumnSums));
 else     deltaColumnSums.muli(conf.getLr());
    if (conf.getMomentum() != 0)     deltaColumnSums.muli(conf.getMomentum());
    deltaColumnSums.divi(input.rows());
    getNeuralNets()[l].gethBias().subi(deltaColumnSums);
    getLayers()[l].setB(getNeuralNets()[l].gethBias());
  }
  INDArray logLayerGradient=deltas.get(getnLayers());
  INDArray biasGradient=deltas.get(getnLayers()).mean(1);
  NeuralNetConfiguration conf=getOutputLayer().conf();
  if (conf.getMomentum() != 0)   logLayerGradient.muli(conf.getMomentum());
  if (conf.isUseAdaGrad())   logLayerGradient.muli(getOutputLayer().getAdaGrad().getLearningRates(logLayerGradient));
 else   logLayerGradient.muli(conf.getLr());
  logLayerGradient.divi(input.rows());
  if (conf.getMomentum() != 0)   biasGradient.muli(conf.getMomentum());
  if (conf.isUseAdaGrad())   biasGradient.muli(getOutputLayer().getBiasAdaGrad().getLearningRates(biasGradient));
 else   biasGradient.muli(conf.getLr());
  biasGradient.divi(input.rows());
  getOutputLayer().getW().subi(logLayerGradient);
  if (getOutputLayer().getB().length() == biasGradient.length())   getOutputLayer().getB().subi(biasGradient);
 else   getOutputLayer().getB().subi(biasGradient.mean(Integer.MAX_VALUE));
}
