{
  final Set<String> encountered=new HashSet<>();
  if (message instanceof VocabWork) {
    final List<SequenceElement> document=new ArrayList<>();
    final VocabWork work=(VocabWork)message;
    if (work.getWork() == null || work.getWork().isEmpty())     return;
    final String sentence=work.getWork();
    if (sentence.isEmpty() || sentence.length() <= 2) {
      work.increment();
      lastUpdate.getAndSet(System.currentTimeMillis());
      return;
    }
    Future<Object> f=Futures.future(new Callable<Object>(){
      @Override public Object call() throws Exception {
        numWordsEncountered.set(numWordsEncountered.get() + document.size());
        Tokenizer t=tokenizer.create(sentence);
        while (t.hasMoreTokens()) {
          String token=t.nextToken();
          if (token.isEmpty())           break;
          processToken(token,encountered,document,work.isStem());
        }
        if (work.getLabel() != null)         index.addWordsToDoc(index.numDocuments(),document,work.getLabel());
 else         index.addWordsToDoc(index.numDocuments(),document);
        return null;
      }
    }
,context().dispatcher());
    f.onFailure(new OnFailure(){
      @Override public void onFailure(      Throwable failure) throws Throwable {
        log.error("Failure on vocab actor ",failure);
      }
    }
,context().dispatcher());
    f.onSuccess(new OnSuccess<Object>(){
      @Override public void onSuccess(      Object result) throws Throwable {
        work.increment();
        lastUpdate.getAndSet(System.currentTimeMillis());
      }
    }
,context().dispatcher());
  }
 else   if (message instanceof StreamWork) {
    StreamWork work=(StreamWork)message;
    List<SequenceElement> document=new ArrayList<>();
    InputStream is=work.getIs();
    if (is == null)     return;
    boolean tryRead=false;
    try {
      if (is.available() > 0) {
        tryRead=true;
      }
    }
 catch (    Exception e) {
      tryRead=false;
    }
    if (!tryRead)     return;
    Tokenizer t=tokenizer.create(is);
    while (t.hasMoreTokens()) {
      String token=t.nextToken();
      if (token == null || token.isEmpty())       break;
      processToken(token,encountered,document,false);
    }
    index.addWordsToDoc(index.numDocuments(),document);
    numWordsEncountered.set(numWordsEncountered.get() + document.size());
    IOUtils.closeQuietly(is);
    work.countDown();
    lastUpdate.getAndSet(System.currentTimeMillis());
  }
 else   unhandled(message);
}
