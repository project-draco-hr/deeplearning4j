{
  String multiGradientKey;
  gradient=new DefaultGradient();
  Layer currLayer, prevLayer;
  if (!(getOutputLayer() instanceof OutputLayer)) {
    log.warn("Warning: final layer isn't output layer. You cannot use backprop without an output layer.");
    return;
  }
  feedForward();
  OutputLayer outputLayer=(OutputLayer)getOutputLayer();
  if (labels == null)   throw new IllegalStateException("No labels found");
  if (outputLayer.conf().getWeightInit() == WeightInit.ZERO) {
    throw new IllegalStateException("Output layer weights cannot be initialized to zero when using backprop.");
  }
  outputLayer.setLabels(labels);
  int numLayers=getnLayers();
  Pair<Gradient,INDArray> currentPair=outputLayer.backpropGradient(null,null,null);
  if (getLayerWiseConfigurations().getInputPreProcess(numLayers - 1) != null)   currentPair=this.layerWiseConfigurations.getInputPreProcess(numLayers - 1).backprop(currentPair);
  Map<String,INDArray> tempGradientMap=currentPair.getFirst().gradientForVariable();
  for (  Map.Entry<String,INDArray> entry : tempGradientMap.entrySet()) {
    multiGradientKey=String.valueOf(numLayers) + "_" + entry.getKey();
    gradient.setGradientFor(multiGradientKey,entry.getValue());
  }
  prevLayer=outputLayer;
  for (int j=numLayers - 2; j >= 0; j--) {
    currLayer=getLayer(j);
    if (getLayerWiseConfigurations().getOutputPostProcess(j) != null)     currentPair=this.layerWiseConfigurations.getOutputPostProcess(j).backprop(currentPair);
    currentPair=currLayer.backpropGradient(currentPair.getSecond(),currentPair.getFirst(),prevLayer);
    prevLayer=currLayer;
    tempGradientMap=currentPair.getFirst().gradientForVariable();
    for (    Map.Entry<String,INDArray> entry : tempGradientMap.entrySet()) {
      multiGradientKey=String.valueOf(j) + "_" + entry.getKey();
      gradient.setGradientFor(multiGradientKey,entry.getValue());
    }
    if (getLayerWiseConfigurations().getInputPreProcess(j) != null)     currentPair=this.layerWiseConfigurations.getInputPreProcess(j).backprop(currentPair);
  }
  score=outputLayer.score();
}
