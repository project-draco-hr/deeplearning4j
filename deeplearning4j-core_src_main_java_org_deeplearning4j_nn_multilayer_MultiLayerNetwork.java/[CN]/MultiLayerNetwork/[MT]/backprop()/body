{
  setInput(input);
  gradient=new DefaultGradient();
  Layer currLayer, prevLayer;
  if (!(getOutputLayer() instanceof OutputLayer)) {
    log.warn("Warning: final layer isn't output layer. You cannot use backprop without an output layer.");
    return;
  }
  List<INDArray> activations=feedForward();
  OutputLayer outputLayer=(OutputLayer)getOutputLayer();
  if (labels == null)   throw new IllegalStateException("No labels found");
  if (outputLayer.conf().getWeightInit() == WeightInit.ZERO) {
    throw new IllegalStateException("Output layer weights cannot be initialized to zero when using backprop.");
  }
  outputLayer.setLabels(labels);
  outputLayer.computeGradientAndScore();
  int numLayers=getnLayers();
  Gradient layerGradient=outputLayer.backpropGradient(null,null);
  for (  String paramType : outputLayer.gradient().gradientForVariable().keySet()) {
    String multiGradientKey=String.valueOf(numLayers) + "_" + paramType;
    gradient.setGradientFor(multiGradientKey,outputLayer.gradient().getGradientFor(paramType));
  }
  prevLayer=outputLayer;
  for (int j=numLayers - 2; j >= 0; j--) {
    currLayer=getLayers()[j];
    layerGradient=currLayer.backpropGradient(layerGradient,prevLayer);
    prevLayer=currLayer;
    for (    String paramType : layerGradient.gradientForVariable().keySet()) {
      String multiGradientKey=String.valueOf(j) + "_" + paramType;
      gradient.setGradientFor(multiGradientKey,layerGradient.getGradientFor(paramType));
    }
  }
  score=outputLayer.score();
}
