{
  INDArray inputData=Nd4j.ones(miniBatchSize,nIn,timeSeriesLength);
  NeuralNetConfiguration conf=new NeuralNetConfiguration.Builder().activationFunction("tanh").weightInit(WeightInit.DISTRIBUTION).dist(new UniformDistribution(0,1)).layer(new org.deeplearning4j.nn.conf.layers.GravesLSTM()).nIn(nIn).nOut(lstmNHiddenUnits).build();
  GravesLSTM lstm=LayerFactories.getFactory(conf.getLayer()).create(conf);
  lstm.activate(inputData);
  NeuralNetConfiguration confOut=new NeuralNetConfiguration.Builder().activationFunction("tanh").layer(new org.deeplearning4j.nn.conf.layers.OutputLayer()).weightInit(WeightInit.DISTRIBUTION).dist(new UniformDistribution(0,1)).lossFunction(LossFunctions.LossFunction.MCXENT).nIn(17).nOut(3).build();
  OutputLayer outLayer=LayerFactories.getFactory(confOut.getLayer()).create(confOut);
  Gradient gradient=new DefaultGradient();
  INDArray pseudoBiasGradients=Nd4j.ones(miniBatchSize,nOut,timeSeriesLength);
  gradient.gradientForVariable().put(DefaultParamInitializer.BIAS_KEY,pseudoBiasGradients);
  INDArray pseudoWeightGradients=Nd4j.ones(miniBatchSize,lstmNHiddenUnits,nOut,timeSeriesLength);
  gradient.gradientForVariable().put(DefaultParamInitializer.WEIGHT_KEY,pseudoWeightGradients);
  INDArray sigmaPrimeZLSTM=Nd4j.ones(miniBatchSize,lstmNHiddenUnits,timeSeriesLength);
  Gradient outGradient=lstm.backwardGradient(sigmaPrimeZLSTM,outLayer,gradient,inputData);
  INDArray biasGradient=outGradient.getGradientFor(GravesLSTMParamInitializer.BIAS);
  INDArray inWeightGradient=outGradient.getGradientFor(GravesLSTMParamInitializer.INPUT_WEIGHTS);
  INDArray recurrentWeightGradient=outGradient.getGradientFor(GravesLSTMParamInitializer.RECURRENT_WEIGHTS);
  assertNotNull(biasGradient);
  assertNotNull(inWeightGradient);
  assertNotNull(recurrentWeightGradient);
  assertArrayEquals(biasGradient.shape(),new int[]{miniBatchSize,4 * lstmNHiddenUnits});
  assertArrayEquals(inWeightGradient.shape(),new int[]{nIn,4 * lstmNHiddenUnits});
  assertArrayEquals(recurrentWeightGradient.shape(),new int[]{lstmNHiddenUnits,4 * lstmNHiddenUnits + 3});
  for (  String s : outGradient.gradientForVariable().keySet()) {
    lstm.update(outGradient.getGradientFor(s),s);
  }
}
