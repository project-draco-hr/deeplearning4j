{
  int batchSize=conf.getConf(0).getBatchSize();
  JavaRDD<DataSet> miniBatches=new RDDMiniBatches(batchSize,rdd).miniBatchesJava();
  MultiLayerNetwork network=new MultiLayerNetwork(conf);
  network.init();
  INDArray params=network.params();
  int paramsLength=network.numParams();
  if (params.length() != paramsLength)   throw new IllegalStateException("Number of params " + paramsLength + " was not equal to "+ params.length());
  DL4jWorker worker=new DL4jWorker(conf.toJson(),params);
  INDArray newParams=miniBatches.map(worker).reduce(new Function2<INDArray,INDArray,INDArray>(){
    @Override public INDArray call(    INDArray v1,    INDArray v2) throws Exception {
      return v1.addi(v2);
    }
  }
).divi(miniBatches.count());
  network.setParameters(newParams);
  this.network=network;
  return network;
}
