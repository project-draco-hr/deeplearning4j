{
  RandomGenerator gen=new MersenneTwister(123);
  int rows=28;
  int cols=28;
  double fanIn=28 * 28;
  double abs=Math.sqrt(6 / fanIn);
  ConvolutionalRBM r=new ConvolutionalRBM.Builder().withFilterSize(new int[]{7,7}).withNumFilters(new int[]{9,9}).withStride(new int[]{2,2}).withVisibleSize(new int[]{rows,cols}).withLossFunction(NeuralNetwork.LossFunction.NEGATIVELOGLIKELIHOOD).withOptmizationAlgo(NeuralNetwork.OptimizationAlgorithm.CONJUGATE_GRADIENT).withRandom(gen).withSparsity(5e-2f).withSparseGain(5).numberOfVisible(28).numHidden(28).withMomentum(0.5f).build();
  DataSetIterator iter=new MnistDataSetIterator(1,200);
  while (iter.hasNext()) {
    DataSet next=iter.next();
    log.info("Len " + next.getFeatureMatrix().length());
    INDArray reshape=next.getFeatureMatrix().reshape(rows,cols);
    INDArray W=(INDArray)r.getW();
    log.info("W shape " + W.shape());
    r.fit(reshape,5e-2f,new Object[]{1,5e-2f,20});
  }
  ;
  FileUtils.writeObject(new File("mnist-conv.ser"),r);
  drawFilters(r);
}
