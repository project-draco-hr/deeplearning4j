{
  int k=(int)params[0];
  double learningRate=(double)params[1];
  if (wAdaGrad != null)   wAdaGrad.setMasterStepSize(learningRate);
  if (hBiasAdaGrad != null)   hBiasAdaGrad.setMasterStepSize(learningRate);
  if (vBiasAdaGrad != null)   vBiasAdaGrad.setMasterStepSize(learningRate);
  FourDTensor chainStart=propUp(input);
  this.chainStart=chainStart;
  FourDTensor nvSamples=null;
  FourDTensor hiddenMeans=chainStart;
  for (int i=0; i < k; i++) {
    nvSamples=propDown(binomial(eHid,1,rng));
    hiddenMeans=propUp(nvSamples);
  }
  FourDTensor wGradient=new FourDTensor(W.rows(),W.columns(),W.slices(),W.getNumTensor());
  for (int i=0; i < numFilters[0]; i++)   for (int j=0; j < numFilters[1]; j++) {
    wGradient.put(j,i,conv2d(input,chainStart.getSliceOfTensor(j,i),VALID).sub(conv2d(nvSamples,reverse(hiddenMeans.getSliceOfTensor(j,i)),VALID)));
  }
  DoubleMatrix vBiasGradient=DoubleMatrix.scalar(chainStart.sub(hiddenMeans).columnSums().sum());
  DoubleMatrix hBiasGradient=DoubleMatrix.scalar((input.sub(nvSamples)).columnSums().sum());
  NeuralNetworkGradient ret=new NeuralNetworkGradient(wGradient,vBiasGradient,hBiasGradient);
  updateGradientAccordingToParams(ret,learningRate);
  triggerGradientEvents(ret);
  return ret;
}
