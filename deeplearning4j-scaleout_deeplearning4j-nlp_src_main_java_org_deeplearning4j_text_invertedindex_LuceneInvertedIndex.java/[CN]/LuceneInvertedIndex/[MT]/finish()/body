{
  if (cache) {
    indexManager.execute(new Runnable(){
      public void run(){
        try {
          IndexWriterConfig iwc=new IndexWriterConfig(Version.LATEST,analyzer);
          if (dir == null)           dir=FSDirectory.open(new File(INDEX_PATH));
          if (writer == null)           if (!indexBeingCreated.get())           writer=new IndexWriter(dir,iwc);
 else           waitOnWriter();
          if (IndexWriter.isLocked(dir))           IndexWriter.unlock(dir);
          writer.forceMerge(1);
          writer.commit();
          initReader();
          numDocs=reader.numDocs();
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
);
  }
 else {
    try {
      log.info("Committing index...");
      writer.forceMerge(1);
      writer.commit();
      log.info("Finished committing changes");
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
    initReader();
    numDocs=reader.numDocs();
    try {
      reader.close();
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
  }
  indexManager.shutdown();
  miniBatchManager.shutdown();
  try {
    indexManager.awaitTermination(1,TimeUnit.DAYS);
    miniBatchGoing.set(false);
    miniBatchManager.awaitTermination(1,TimeUnit.MINUTES);
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
}
