{
  try {
    ensureDirExists();
    if (analyzer == null)     analyzer=new StandardAnalyzer(new InputStreamReader(new ByteArrayInputStream("".getBytes())));
    IndexWriterConfig iwc=new IndexWriterConfig(Version.LATEST,analyzer);
    if (!indexBeingCreated.get() && writer == null) {
      indexBeingCreated.set(true);
      writer=new IndexWriter(dir,iwc);
    }
 else     if (!indexBeingCreated.get()) {
      indexBeingCreated.set(true);
      writer=new IndexWriter(dir,iwc);
    }
  }
 catch (  LockObtainFailedException e) {
    try {
      IndexWriter.unlock(dir);
    }
 catch (    IOException e1) {
      throw new RuntimeException("Unable to unlock directory " + indexPath);
    }
    try {
      IndexWriterConfig iwc=new IndexWriterConfig(Version.LATEST,analyzer);
      writer=new IndexWriter(dir,iwc);
    }
 catch (    IOException e1) {
      log.warn("Failed to created writer...trying again");
      createWriter();
    }
  }
catch (  Exception e) {
    throw new IllegalStateException("Failed to created writer",e);
  }
}
