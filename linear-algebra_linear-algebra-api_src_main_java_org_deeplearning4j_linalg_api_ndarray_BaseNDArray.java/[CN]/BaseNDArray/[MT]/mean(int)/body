{
  if (dimension == Integer.MAX_VALUE || isVector()) {
    return NDArrays.scalar(Ops.mean(this));
  }
 else   if (isVector()) {
    return NDArrays.scalar((double)sum(Integer.MAX_VALUE).element() / length());
  }
 else {
    int[] shape=ArrayUtil.removeIndex(shape(),dimension);
    final INDArray arr=NDArrays.create(new int[]{ArrayUtil.prod(shape)});
    final AtomicInteger i=new AtomicInteger(0);
    iterateOverDimension(dimension,new SliceOp(){
      @Override public void operate(      DimensionSlice nd){
        INDArray arr2=(INDArray)nd.getResult();
        arr.put(i.get(),arr2.mean(0));
        i.incrementAndGet();
      }
      /** 
 * Operates on an ndarray slice
 * @param nd the result to operate on
 */
      @Override public void operate(      INDArray nd){
        arr.put(i.get(),nd.mean(0));
        i.incrementAndGet();
      }
    }
,false);
    return arr.reshape(shape);
  }
}
