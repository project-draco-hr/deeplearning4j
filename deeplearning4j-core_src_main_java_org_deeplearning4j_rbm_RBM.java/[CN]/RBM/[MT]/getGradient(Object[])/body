{
  int k=(int)params[0];
  Pair<DoubleMatrix,DoubleMatrix> probHidden=sampleHiddenGivenVisible(input);
  DoubleMatrix chainStart=probHidden.getSecond();
  Pair<Pair<DoubleMatrix,DoubleMatrix>,Pair<DoubleMatrix,DoubleMatrix>> matrices=null;
  DoubleMatrix nvMeans=null;
  DoubleMatrix nvSamples=null;
  DoubleMatrix nhMeans=null;
  DoubleMatrix nhSamples=null;
  for (int i=0; i < k; i++) {
    if (i == 0)     matrices=gibbhVh(chainStart);
 else     matrices=gibbhVh(nhSamples);
    nvMeans=matrices.getFirst().getFirst();
    nvSamples=matrices.getFirst().getSecond();
    nhMeans=matrices.getSecond().getFirst();
    nhSamples=matrices.getSecond().getSecond();
  }
  DoubleMatrix wGradient=input.transpose().mmul(probHidden.getSecond()).sub(nvSamples.transpose().mmul(nhMeans));
  wGradient=wGradient.mul(adaGrad.getLearningRates(wGradient));
  if (useRegularization)   wGradient.subi(W.muli(l2));
  if (momentum != 0)   wGradient.muli(1 - momentum);
  if (useRegularization)   wGradient.divi(input.rows);
  DoubleMatrix hBiasGradient=null;
  if (this.sparsity != 0) {
    hBiasGradient=mean(probHidden.getSecond().add(-sparsity),0);
    hBiasGradient=hBiasGradient.mul(this.hBiasAdaGrad.getLearningRates(hBiasGradient));
  }
 else {
    hBiasGradient=mean(probHidden.getSecond().sub(nhMeans),0);
    hBiasGradient=hBiasGradient.mul(hBiasAdaGrad.getLearningRates(hBiasGradient));
  }
  DoubleMatrix vBiasGradient=mean(input.sub(nvSamples),0);
  vBiasGradient.mul(vBiasAdaGrad.getLearningRates(vBiasGradient));
  return new NeuralNetworkGradient(wGradient,vBiasGradient,hBiasGradient);
}
