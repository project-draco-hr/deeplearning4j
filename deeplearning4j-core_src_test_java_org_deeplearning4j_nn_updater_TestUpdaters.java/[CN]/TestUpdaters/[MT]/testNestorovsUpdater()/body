{
  double lr=1e-2;
  double mu=0.6;
  NeuralNetConfiguration conf=new NeuralNetConfiguration.Builder().learningRate(lr).momentum(mu).layer(new DenseLayer.Builder().nIn(nIn).nOut(nOut).updater(org.deeplearning4j.nn.conf.Updater.NESTEROVS).build()).build();
  Layer layer=LayerFactories.getFactory(conf).create(conf,null,0);
  Updater updater=UpdaterCreator.getUpdater(layer);
  updater.update(layer,gradient,-1);
  INDArray vW, vPrevW, weightGradExpected, vB, vPrevB, biasGradExpected;
  vW=Nd4j.zeros(weightGradient.shape());
  vPrevW=vW;
  vW=vPrevW.mul(mu).subi(weightGradient.mul(lr));
  weightGradExpected=vPrevW.muli(mu).addi(vW.mul(-mu - 1));
  vB=Nd4j.zeros(biasGradient.shape());
  vPrevB=vB;
  vB=vPrevB.mul(mu).subi(biasGradient.mul(lr));
  biasGradExpected=vPrevB.muli(mu).addi(vB.mul(-mu - 1));
  INDArray weightGradActual=gradient.getGradientFor(DefaultParamInitializer.WEIGHT_KEY);
  INDArray biasGradActual=gradient.getGradientFor(DefaultParamInitializer.BIAS_KEY);
  assertEquals(weightGradExpected,weightGradActual);
  assertEquals(biasGradExpected,biasGradActual);
  assertEquals(mu,layer.conf().getMomentum(),1e-4);
}
